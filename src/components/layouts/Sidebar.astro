---
import "../../styles/tailwind.css";
import RoleLoader from "../react/RoleLoader";

// Hardcode backend URL here to avoid import.meta in browser <script>
const API = "https://jira-clone-backend-oemb.onrender.com";
---

<RoleLoader client:load />

<aside class="w-64 min-h-screen bg-white border-r p-6 shadow-sm">
  <h2 class="text-xl font-bold mb-8 text-gray-900">Jira Clone</h2>

  <nav id="sidebar-links" class="space-y-3"></nav>
</aside>

<script>
  const API = "https://jira-clone-backend-oemb.onrender.com";

  async function getInviteCount() {
    try {
      const token = localStorage.getItem("jira_clone_token");
      if (!token) return 0;

      const res = await fetch(`${API}/projects/invitations/me`, {
        headers: { Authorization: `Bearer ${token}` },
      });

      if (!res.ok) return 0;

      const data = await res.json();
      return Array.isArray(data) ? data.length : 0;
    } catch {
      return 0;
    }
  }

  const userLinks = async () => {
    const count = await getInviteCount();
    return [
      { label: "My Projects", href: "/my-projects" },
      {
        label:
          count > 0
            ? `Invitations <span class="ml-1 bg-red-600 text-white text-xs px-2 py-0.5 rounded-full">${count}</span>`
            : "Invitations",
        html: true,
        href: "/invitations",
      },
      { label: "AI Insights", href: "/ai-insights" },
    ];
  };

  const adminLinks = [
    { label: "Admin Dashboard", href: "" },
    { label: "Projects", href: "/projects" },
    { label: "AI Insights", href: "/ai-insights" },
  ];

  function renderLinks(links) {
    const sidebar = document.getElementById("sidebar-links");
    if (!sidebar) return;

    sidebar.innerHTML = links
      .map(
        (item) => `
        <a href="${item.href}" class="block text-gray-700 hover:text-blue-600 font-medium text-sm">
          ${item.label}
        </a>
      `
      )
      .join("");
  }

  async function initSidebar() {
    if (window.__USER_ROLE__ === "admin") {
      renderLinks(adminLinks);
    } else if (window.__USER_ROLE__) {
      renderLinks(await userLinks());
    }
  }

  initSidebar();

  const interval = setInterval(async () => {
    if (window.__USER_ROLE__) {
      clearInterval(interval);
      await initSidebar();
    }
  }, 100);
</script>
